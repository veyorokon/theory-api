name: Modal Deploy

on:
  push:
    branches: [dev, staging, main]
  workflow_dispatch:
    inputs:
      environment:
        description: "Modal environment override (dev|staging|main)"
        required: false
        default: ""

jobs:
  deploy:
    name: Deploy to Modal
    runs-on: ubuntu-latest
    # Map git branch to GitHub Environment
    environment: ${{ inputs.environment != '' && inputs.environment || (github.ref_name == 'main' && 'prod' || github.ref_name) }}
    permissions:
      contents: read
    env:
      PIP_DISABLE_PIP_VERSION_CHECK: "1"
      PYTHONUNBUFFERED: "1"
      MODAL_ENVIRONMENT: ${{ inputs.environment != '' && inputs.environment || github.ref_name }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install -U pip wheel
          pip install -r requirements.txt
          pip install modal pyyaml

      - name: Deploy all processors to Modal
        working-directory: code
        env:
          MODAL_TOKEN_ID: ${{ secrets.MODAL_TOKEN_ID }}
          MODAL_TOKEN_SECRET: ${{ secrets.MODAL_TOKEN_SECRET }}
        run: |
          set -euo pipefail
          python - <<'PY'
          import yaml, os, subprocess, glob

          # Find all processor registry files
          registry_files = glob.glob("apps/core/registry/processors/*.yaml")

          for registry_file in registry_files:
              doc = yaml.safe_load(open(registry_file))
              processor_ref = doc["ref"]
              image_ref = doc["image"]["oci"]

              # Determine secrets based on processor type
              if "llm" in processor_ref:
                  secrets = "OPENAI_API_KEY"
              elif "replicate" in processor_ref:
                  secrets = "REPLICATE_API_TOKEN"
              else:
                  secrets = ""

              # Set environment variables for this processor
              env = os.environ.copy()
              env["IMAGE_REF"] = image_ref
              env["PROCESSOR_REF"] = processor_ref
              env["TOOL_SECRETS"] = secrets

              print(f"\n🚀 Deploying {processor_ref} with image {image_ref}")

              # Deploy to Modal
              cmd = ["modal", "deploy", "--env", os.environ["MODAL_ENVIRONMENT"], "-m", "modal_app"]
              result = subprocess.run(cmd, env=env, capture_output=True, text=True)

              if result.returncode != 0:
                  print(f"❌ Failed to deploy {processor_ref}")
                  print(f"STDERR: {result.stderr}")
                  exit(1)
              else:
                  print(f"✅ Successfully deployed {processor_ref}")
          PY

      - name: Post-deploy smoke tests for all processors
        working-directory: code
        env:
          DJANGO_SETTINGS_MODULE: backend.settings.unittest
          MODAL_ENABLED: "true"
          MODAL_ENVIRONMENT: ${{ inputs.environment != '' && inputs.environment || github.ref_name }}
        run: |
          set -euo pipefail
          python - <<'PY'
          import yaml, json, subprocess, glob

          # Test each deployed processor
          registry_files = glob.glob("apps/core/registry/processors/*.yaml")

          for registry_file in registry_files:
              doc = yaml.safe_load(open(registry_file))
              processor_ref = doc["ref"]

              print(f"\n🧪 Testing {processor_ref}...")

              # Determine test inputs based on processor type
              if "llm" in processor_ref:
                  inputs_json = '{"schema":"v1","model":"gpt-4o-mini","params":{"messages":[{"role":"user","content":"deployment smoke test"}]},"mode":"mock"}'
              elif "replicate" in processor_ref:
                  inputs_json = '{"schema":"v1","model":"black-forest-labs/flux-schnell","params":{"prompt":"test image"},"mode":"mock"}'
              else:
                  print(f"⚠️ Skipping unknown processor type: {processor_ref}")
                  continue

              cmd = [
                  "python", "manage.py", "run_processor",
                  "--ref", processor_ref,
                  "--adapter", "modal",
                  "--mode", "smoke",
                  "--write-prefix", "/artifacts/outputs/smoke/{execution_id}/",
                  "--inputs-json", inputs_json,
                  "--json"
              ]

              result = subprocess.run(cmd, capture_output=True, text=True)

              if result.returncode != 0:
                  print(f"❌ Smoke test failed for {processor_ref}")
                  print(f"STDERR: {result.stderr}")
                  exit(1)

              # Validate response
              try:
                  payload = json.loads(result.stdout)
                  assert payload.get("status") == "success", f"Status not success: {payload}"
                  assert payload.get("execution_id"), "Missing execution_id"
                  print(f"✅ {processor_ref} verified: {payload['execution_id']}")
              except (json.JSONDecodeError, AssertionError) as e:
                  print(f"❌ Validation failed for {processor_ref}: {e}")
                  print(f"Output: {result.stdout}")
                  exit(1)
          PY

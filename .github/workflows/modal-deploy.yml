name: Modal Deploy

on:
  push:
    branches: [ main ]

jobs:
  deploy-modal:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      MODAL_TOKEN_ID:     ${{ secrets.MODAL_TOKEN_ID }}
      MODAL_TOKEN_SECRET: ${{ secrets.MODAL_TOKEN_SECRET }}

      # Modal environment (dev|staging|main)
      MODAL_ENVIRONMENT: dev

      # Processor parameters (pin all)
      PROCESSOR_REF: llm/litellm@1
      IMAGE_REF: ghcr.io/veyorokon/llm_litellm@sha256:6314df9935cad6a69486f254c820c079702be35d7d11b604b2d0ea066d86d60b
      TIMEOUT_S: "60"
      CPU: "1"
      MEMORY_MIB: "2048"
      GPU: ""

      # Tool secrets (names must match env vars used by processor)
      TOOL_SECRETS: OPENAI_API_KEY

      # Stable Modal app name
      MODAL_APP_NAME: theory-rt

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Modal CLI
        run: |
          python -m pip install --upgrade pip
          pip install modal

      - name: Deploy Modal app module
        working-directory: code
        run: |
          modal deploy --env "$MODAL_ENVIRONMENT" -m modal_app
